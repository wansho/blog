<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>三国演义重要战役路线图</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Microsoft YaHei', sans-serif;
      overflow: hidden;
      color: #333;
      background: linear-gradient(135deg, #f9f1e8 0%, #e8eaf6 100%);
    }
    
    #map-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    #map {
      height: 100%;
      width: 100%;
    }
    
    #title-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(209, 196, 180, 0.4);
    }
    
    .title-group {
      display: flex;
      flex-direction: column;
    }
    
    #title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #8b0000;
      letter-spacing: 1px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }
    
    #title i {
      margin-right: 10px;
      color: #b71c1c;
    }
    
    #subtitle {
      font-size: 0.9rem;
      color: #5d4037;
      opacity: 0.8;
    }
    
    #controls {
      display: flex;
      gap: 10px;
    }
    
    .control-btn {
      background: #8b0000;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn:hover {
      background: #6b0000;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
    }
    
    .control-btn i {
      margin-right: 6px;
    }
    
    #timeline {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.92);
      border-radius: 50px;
      padding: 12px 30px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      z-index: 10;
      display: flex;
      gap: 20px;
    }
    
    .time-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 70px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 8px;
      transition: background 0.3s;
    }
    
    .time-item:hover {
      background: rgba(139, 0, 0, 0.1);
    }
    
    .time-year {
      font-size: 1.1rem;
      font-weight: bold;
      color: #8b0000;
    }
    
    .time-name {
      font-size: 0.85rem;
      color: #5d4037;
      text-align: center;
      margin-top: 4px;
    }
    
    .active-time {
      background: rgba(139, 0, 0, 0.15);
      position: relative;
    }
    
    .active-time::after {
      content: '';
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      background: #8b0000;
      border-radius: 50%;
    }
    
    .custom-label {
      background: linear-gradient(to right, #8b0000, #a52a2a);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      color: white;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      max-width: 180px;
      line-height: 1.4;
    }
    
    .custom-label strong {
      font-size: 15px;
      display: block;
      margin-bottom: 2px;
    }
    
    .fly-line {
      stroke: #8b0000;
      stroke-width: 3;
      stroke-dasharray: 10, 5;
      fill: none;
      animation: fly 6s linear infinite;
    }
    
    @keyframes fly {
      from {
        stroke-dashoffset: 100;
      }
      to {
        stroke-dashoffset: 0;
      }
    }
    
    .arrowhead {
      fill: #8b0000;
    }
    
    #info-panel {
      position: absolute;
      right: 20px;
      top: 90px;
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
      z-index: 10;
      border: 1px solid rgba(209, 196, 180, 0.4);
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.4s ease;
    }
    
    #info-panel.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 2px solid #8b0000;
      padding-bottom: 12px;
    }
    
    .info-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #8b0000;
    }
    
    .info-close {
      background: #e9ecef;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5d4037;
      transition: all 0.3s;
    }
    
    .info-close:hover {
      background: #dc3545;
      color: white;
    }
    
    .info-content {
      line-height: 1.6;
    }
    
    .info-row {
      margin-bottom: 10px;
      display: flex;
    }
    
    .info-label {
      width: 80px;
      font-weight: bold;
      color: #5d4037;
    }
    
    .info-value {
      flex: 1;
      color: #444;
    }
    
    #legend {
      position: absolute;
      bottom: 100px;
      right: 20px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      z-index: 10;
      font-size: 14px;
      border: 1px solid rgba(209, 196, 180, 0.4);
    }
    
    .legend-title {
      font-weight: bold;
      color: #8b0000;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }
    
    .legend-icon {
      width: 24px;
      height: 24px;
      margin-right: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .event-marker {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #8b0000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .event-marker::after {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ffd54f;
    }
    
    .fly-line-legend {
      width: 30px;
      height: 4px;
      background: linear-gradient(90deg, #8b0000 0%, #ff6b6b 100%);
      position: relative;
      overflow: hidden;
    }
    
    .fly-line-legend::after {
      content: '';
      position: absolute;
      top: 0;
      left: -30px;
      width: 30px;
      height: 100%;
      background: white;
      animation: flyLegend 2s linear infinite;
    }
    
    @keyframes flyLegend {
      0% {
        left: -30px;
      }
      100% {
        left: 100%;
      }
    }
    
    @media (max-width: 768px) {
      #title-bar {
        flex-direction: column;
        gap: 10px;
      }
      
      #controls {
        width: 100%;
        justify-content: center;
      }
      
      #timeline {
        flex-wrap: wrap;
        width: 90%;
        border-radius: 20px;
        padding: 10px;
      }
      
      .time-item {
        min-width: 50px;
      }
      
      #info-panel {
        width: calc(100% - 40px);
        top: auto;
        bottom: 80px;
        left: 20px;
        max-height: 200px;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="map"></div>
    
    <div id="title-bar">
      <div class="title-group">
        <h1 id="title"><i class="fas fa-map-marked-alt"></i> 三国演义重要战役路线图</h1>
        <p id="subtitle">探索三国时期重要战役的地理位置和历史事件</p>
      </div>
      <div id="controls">
        <button class="control-btn" id="toggleFly"><i class="fas fa-bolt"></i> 飞线效果</button>
        <button class="control-btn" id="toggleInfo"><i class="fas fa-book-open"></i> 事件详情</button>
      </div>
    </div>
    
    <div id="timeline">
      <div class="time-item active-time" data-year="184">
        <span class="time-year">184年</span>
        <span class="time-name">桃园三结义</span>
      </div>
      <div class="time-item" data-year="190">
        <span class="time-year">190年</span>
        <span class="time-name">虎牢关之战</span>
      </div>
      <div class="time-item" data-year="190">
        <span class="time-year">190年</span>
        <span class="time-name">汜水关战役</span>
      </div>
    </div>
    
    <div id="info-panel">
      <div class="info-header">
        <div class="info-title" id="infoTitle">桃园三结义</div>
        <button class="info-close"><i class="fas fa-times"></i></button>
      </div>
      <div class="info-content" id="infoContent">
        <div class="info-row">
          <div class="info-label">古地名：</div>
          <div class="info-value" id="infoAncient">涿郡</div>
        </div>
        <div class="info-row">
          <div class="info-label">时间：</div>
          <div class="info-value" id="infoTime">公元184年</div>
        </div>
        <div class="info-row">
          <div class="info-value" id="infoDetail">刘备、关羽、张飞于桃园结义，发誓同生共死。</div>
        </div>
      </div>
    </div>
    
    <div id="legend">
      <div class="legend-title"><i class="fas fa-key"></i> 图例说明</div>
      <div class="legend-item">
        <div class="legend-icon">
          <div class="event-marker"></div>
        </div>
        <div>历史事件位置</div>
      </div>
      <div class="legend-item">
        <div class="legend-icon">
          <div class="fly-line-legend"></div>
        </div>
        <div>事件发展路线</div>
      </div>
    </div>
  </div>

  <script>
    // 确保百度地图API加载完成后再执行初始化
    function initMap() {
      // 创建地图实例
      const map = new BMapGL.Map("map");
      map.centerAndZoom(new BMapGL.Point(112.5, 34.6), 6);
      map.enableScrollWheelZoom(true);
      
      // 存储SVG覆盖物用于控制动画
      const flyLines = [];
      let flyAnimationEnabled = true;
      
      // 定义历史事件数据点
      const points = [
        {
          name: "桃园三结义",
          lng: 112.5,
          lat: 34.6,
          detail: "刘备、关羽、张飞于桃园结义，发誓同生共死。这一事件标志着三国鼎立局面的开端，为日后蜀汉政权的建立奠定了基础。",
          time: "公元184年",
          ancientName: "涿郡",
          description: "东汉末年，天下大乱。刘备、关羽和张飞在涿郡张飞庄后桃园，备下乌牛白马，祭告天地，焚香结拜为异姓兄弟，立誓：'同心协力，救困扶危；上报国家，下安黎庶。不求同年同月同日生，只愿同年同月同日死。'"
        },
        {
          name: "虎牢关之战",
          lng: 113.4,
          lat: 34.5,
          detail: "关羽温酒斩华雄，张飞大战吕布，三英战吕布名扬天下。此战确立了三人在三国武力排行榜中的地位。",
          time: "公元190年",
          ancientName: "虎牢关",
          description: "董卓专权乱政，以吕布为先锋，与十八路诸侯对峙于虎牢关。曹操联军方面，关羽在温酒未凉之时斩华雄；随后张飞、关羽、刘备三人合力大战吕布，吕布虽勇猛难敌，但也只能退走。此战为三国最著名的武将对决之一。"
        },
        {
          name: "汜水关战役",
          lng: 113.0,
          lat: 34.5,
          detail: "孙坚先攻汜水关，刘关张支援，击败董卓部队。此役展示了三国早期各势力联合作战的模式。",
          time: "公元190年",
          ancientName: "汜水关",
          description: "孙坚率先攻打汜水关，遭遇华雄阻击。在粮草不足的困境下，曹操支持袁绍发檄文集结诸侯。刘备率关羽、张飞加入战斗，配合孙坚部队击败董卓守军。虽未完全攻下汜水关，但展示了联盟的力量，为后续讨伐董卓奠定基础。"
        }
      ];

      // 保存标记点对象
      const pointObjs = [];
      const markers = [];
      const labelObjs = [];

      // 创建事件标记和信息弹窗
      points.forEach((p, index) => {
        const point = new BMapGL.Point(p.lng, p.lat);
        pointObjs.push(point);

        // 创建自定义标记
        const marker = new BMapGL.Marker(point);
        markers.push(marker);
        map.addOverlay(marker);

        // 精简标签
        const brief = `<div class="custom-label">
          <strong>${p.ancientName}</strong><br/>
          ${p.name}<br/>
          ${p.time}
        </div>`;
        
        const label = new BMapGL.Label(brief, {
          position: point,
          offset: new BMapGL.Size(20, -40)
        });
        
        label.setStyle({ border: "none", background: "transparent" });
        map.addOverlay(label);
        labelObjs.push(label);

        // 点击打开详细信息
        marker.addEventListener("click", () => {
          document.getElementById('infoTitle').textContent = p.name;
          document.getElementById('infoAncient').textContent = p.ancientName;
          document.getElementById('infoTime').textContent = p.time;
          document.getElementById('infoDetail').textContent = p.detail;
          document.getElementById('infoContent').innerHTML = `
            <div class="info-row">
              <div class="info-label">古地名：</div>
              <div class="info-value">${p.ancientName}</div>
            </div>
            <div class="info-row">
              <div class="info-label">时间：</div>
              <div class="info-value">${p.time}</div>
            </div>
            <div class="info-row">
              <div class="info-value">${p.description}</div>
            </div>
          `;
          document.getElementById('info-panel').classList.add('show');
          
          // 高亮时间线上的对应事件
          document.querySelectorAll('.time-item').forEach((item, idx) => {
            if (idx === index) {
              item.classList.add('active-time');
            } else {
              item.classList.remove('active-time');
            }
          });
        });
      });

      // 为所有点之间创建路径
      for (let i = 0; i < pointObjs.length - 1; i++) {
        createPath(map, pointObjs[i], pointObjs[i+1]);
      }

      // 创建带动态效果的路径函数
      function createPath(map, start, end) {
        // 创建动态飞线SVG
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "100%");
        svg.style.position = "absolute";
        svg.style.top = "0";
        svg.style.left = "0";
        svg.style.pointerEvents = "none";
        svg.style.zIndex = "5";
        
        const path = document.createElementNS(svgNS, "path");
        path.setAttribute("class", "fly-line");
        path.setAttribute("stroke", "#8b0000");
        path.setAttribute("stroke-width", "3");
        path.setAttribute("stroke-dasharray", "10, 5");
        path.setAttribute("fill", "none");
        
        // 添加箭头标记
        const defs = document.createElementNS(svgNS, "defs");
        const marker = document.createElementNS(svgNS, "marker");
        marker.setAttribute("id", `arrowhead-${start.lng}-${start.lat}`);
        marker.setAttribute("markerWidth", "10");
        marker.setAttribute("markerHeight", "7");
        marker.setAttribute("refX", "0");
        marker.setAttribute("refY", "3.5");
        marker.setAttribute("orient", "auto");
        marker.setAttribute("class", "arrowhead");
        
        const arrow = document.createElementNS(svgNS, "polygon");
        arrow.setAttribute("points", "0 0, 10 3.5, 0 7");
        arrow.setAttribute("fill", "#8b0000");
        
        marker.appendChild(arrow);
        defs.appendChild(marker);
        svg.appendChild(defs);
        svg.appendChild(path);
        path.setAttribute("marker-end", `url(#arrowhead-${start.lng}-${start.lat})`);
        
        // 在地图容器中添加SVG
        document.getElementById('map-container').appendChild(svg);
        
        // 保存SVG引用
        flyLines.push({
          svg: svg,
          path: path,
          start: start,
          end: end,
          enabled: true
        });
        
        // 初始化路径位置
        updatePathPosition(svg, path, start, end);
        
        // 地图缩放移动时更新路径位置
        map.addEventListener("moving", () => updatePathPosition(svg, path, start, end));
        map.addEventListener("zoomend", () => updatePathPosition(svg, path, start, end));
      }
      
      // 更新路径位置
      function updatePathPosition(svg, pathElement, start, end) {
        const startPx = map.pointToOverlayPixel(start);
        const endPx = map.pointToOverlayPixel(end);
        
        const d = `M${startPx.x},${startPx.y} L${endPx.x},${endPx.y}`;
        pathElement.setAttribute("d", d);
        
        // 动态控制动画
        if (flyAnimationEnabled) {
          pathElement.style.animation = "fly 6s linear infinite";
        } else {
          pathElement.style.animation = "none";
        }
      }
      
      // 绑定控制按钮事件
      document.getElementById('toggleFly').addEventListener('click', function() {
        flyAnimationEnabled = !flyAnimationEnabled;
        this.innerHTML = flyAnimationEnabled ? 
          '<i class="fas fa-bolt"></i> 关闭飞线' : 
          '<i class="fas fa-bolt"></i> 开启飞线';
        
        flyLines.forEach(flyLine => {
          if (flyAnimationEnabled) {
            flyLine.path.style.animation = "fly 6s linear infinite";
          } else {
            flyLine.path.style.animation = "none";
          }
        });
      });
      
      document.getElementById('toggleInfo').addEventListener('click', function() {
        const panel = document.getElementById('info-panel');
        if (panel.classList.contains('show')) {
          panel.classList.remove('show');
          this.innerHTML = '<i class="fas fa-book-open"></i> 显示详情';
        } else {
          panel.classList.add('show');
          this.innerHTML = '<i class="fas fa-book-open"></i> 隐藏详情';
        }
      });
      
      document.querySelector('.info-close').addEventListener('click', function() {
        document.getElementById('info-panel').classList.remove('show');
        document.getElementById('toggleInfo').innerHTML = '<i class="fas fa-book-open"></i> 显示详情';
      });
      
      // 添加时间线点击事件
      document.querySelectorAll('.time-item').forEach((item, index) => {
        item.addEventListener('click', () => {
          // 高亮点击的时间项
          document.querySelectorAll('.time-item').forEach(el => {
            el.classList.remove('active-time');
          });
          item.classList.add('active-time');
          
          // 移动到对应的标记点并打开信息
          const marker = markers[index];
          map.panTo(marker.getPosition(), {noAnimation: false});
          setTimeout(() => {
            marker.dispatchEvent(new Event('click'));
          }, 1000);
        });
      });
      
      // 初始显示第一个事件详情
      markers[0].dispatchEvent(new Event('click'));
    }

    // 百度地图API加载回调
    function loadBMap() {
      // 创建script标签加载百度地图API
      const script = document.createElement('script');
      script.src = 'https://api.map.baidu.com/api?v=1.0&type=webgl&ak=QP8jicLhkpvN65WvTP6C8QKZwA1HLamO&callback=initMap';
      document.body.appendChild(script);
    }

    // 页面加载完成后加载百度地图API
    window.onload = loadBMap;
  </script>
</body>
</html>